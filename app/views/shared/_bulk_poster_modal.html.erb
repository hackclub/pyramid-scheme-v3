<div data-bulk-poster-modal-target="dialog" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4" data-state="closed">
  <!-- Backdrop -->
  <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" data-action="click->bulk-poster-modal#closeOnBackdrop"></div>

  <!-- Modal -->
  <div class="relative campaign-modal shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
    <!-- Header -->
    <div class="sticky top-0 campaign-modal-header px-4 sm:px-6 py-3 sm:py-4 flex items-center justify-between">
      <h2 class="campaign-font text-xl sm:text-2xl font-black campaign-text-primary">Generate Bulk Posters</h2>
      <button type="button"
              data-action="click->bulk-poster-modal#close"
              class="campaign-text-muted hover:campaign-text-primary transition-colors">
        <%= icon :x, size: 24 %>
      </button>
    </div>

    <!-- Body -->
    <div class="px-4 sm:px-6 py-4 sm:py-6">
      <!-- Success/Error message placeholder -->
      <turbo-frame id="poster_result" class="mb-4 sm:mb-6"></turbo-frame>

      <%= form_with model: PosterGroup.new, url: poster_groups_path, class: "space-y-4 sm:space-y-5", data: { turbo_frame: "poster_result", bulk_poster_modal_target: "form", action: "turbo:submit-start->bulk-poster-modal#startSubmit turbo:submit-end->bulk-poster-modal#endSubmit" } do |f| %>
        <%= f.hidden_field :campaign_id, value: campaign.id %>

        <!-- Info Box -->
        <div class="campaign-panel-inner p-3 sm:p-4 space-y-2">
          <p class="campaign-font text-sm font-black campaign-text-primary">Generate up to 10 posters at once!</p>
          <p class="text-xs campaign-text-secondary">Each poster gets its own unique QR code and referral link. You can upload proof for each individually or submit them all together.</p>
        </div>

        <!-- Weekly Paid Posters -->
        <div class="campaign-panel-inner p-3 sm:p-4">
          <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-2">
            <div>
              <p class="campaign-font text-sm font-black campaign-text-primary">Weekly Paid Posters</p>
              <p class="text-xs campaign-text-secondary mt-1">Bulk generation counts against your weekly quota. Max <%= PosterGroup::MAX_POSTERS_PER_GROUP %> posters per batch.</p>
            </div>
            <div class="text-right">
              <p class="campaign-font text-lg font-black campaign-text-primary tabular-nums">
                <%= current_user.posters_created_this_week %>/<%= current_user.weekly_paid_poster_limit %>
              </p>
              <p class="text-xs campaign-text-secondary">
                <% if current_user.next_poster_will_be_paid? %>
                  <%= current_user.remaining_paid_posters_this_week %> paid remaining
                <% else %>
                  Over limit (no shards)
                <% end %>
              </p>
            </div>
          </div>
        </div>

        <% max_allowed = [current_user.remaining_paid_posters_this_week, PosterGroup::MAX_POSTERS_PER_GROUP].min %>
        
        <% if max_allowed <= 0 %>
          <div class="campaign-panel-inner p-4 border-2 border-yellow-500/30 bg-yellow-500/10">
            <div class="flex items-start gap-3">
              <%= icon :circle_alert, size: 24, class_name: "text-yellow-600 flex-shrink-0 mt-0.5" %>
              <div>
                <p class="campaign-font text-sm font-black text-yellow-600 mb-1">Quota Exceeded</p>
                <p class="text-sm campaign-text-secondary">
                  You've reached your paid poster limit for this month. You're still free to:
                </p>
                <ul class="text-sm campaign-text-secondary mt-2 list-disc list-inside space-y-1">
                  <li>Create individual unpaid posters (no shard reward)</li>
                  <li>Repeatedly print any existing poster - it doesn't matter!</li>
                </ul>
              </div>
            </div>
          </div>
        <% else %>
          <!-- Number of Posters -->
          <div>
            <label class="block campaign-font text-sm font-black campaign-text-primary mb-2">Number of Posters</label>
            <p class="text-xs campaign-text-secondary mb-2">Generate between 1 and <%= max_allowed %> posters</p>
            <div class="flex items-center gap-3">
              <%= f.number_field :count,
                  min: 1,
                  max: max_allowed,
                  value: [5, max_allowed].min,
                  required: true,
                  class: "flex h-11 w-24 rounded-lg campaign-input px-4 py-2 text-sm text-center font-bold" %>
              <span class="text-sm campaign-text-muted">posters (max <%= max_allowed %>)</span>
            </div>
          </div>

          <!-- Group Name (Optional) -->
          <div>
            <label class="block campaign-font text-sm font-black campaign-text-primary mb-2">Group Name (Optional)</label>
            <p class="text-xs campaign-text-secondary mb-2">Give this batch a name for easy identification</p>
            <%= f.text_field :name,
                placeholder: "e.g., Coffee Shops Downtown, School Bulletin Boards",
                class: "flex h-11 w-full rounded-lg campaign-input px-4 py-2 text-sm" %>
          </div>

          <!-- Poster Type -->
          <div>
            <label class="block campaign-font text-sm font-black campaign-text-primary mb-2 sm:mb-3">Choose Poster Style</label>
            <%
              poster_styles = case campaign.slug
              when "aces"
                [{ value: "color", title: "Color Poster", preview: "aces-poster-color-preview.webp" }]
              when "sleepover"
                [
                  { value: "color", title: "Color Poster", preview: "sleepover-poster-color-preview.webp" },
                  { value: "bw", title: "Black & White Poster", preview: "sleepover-poster-bw-preview.webp" },
                  { value: "printer_efficient", title: "Printer Efficient", preview: "sleepover-poster-printer_efficient-preview.webp" }
                ]
              else
                [
                  { value: "color", title: "Color Poster", preview: "poster-color-preview.webp" },
                  { value: "bw", title: "Black & White Poster", preview: "poster-bw-preview.webp" },
                  { value: "printer_efficient", title: "Printer Efficient", preview: "poster-printer_efficient-preview.webp" }
                ]
              end
              grid_cols = poster_styles.length == 1 ? "grid-cols-1 max-w-xs mx-auto" : "grid-cols-3"
            %>
            <div class="grid <%= grid_cols %> gap-3 sm:gap-4">
              <% poster_styles.each do |style| %>
                <label class="relative cursor-pointer block rounded-lg transition-all <%= style[:value] == 'color' ? 'ring-4 ring-current/70 ring-offset-2' : '' %>"
                       id="bulk_poster_style_label_<%= style[:value] %>"
                       onclick="document.querySelectorAll('[id^=bulk_poster_style_label]').forEach(l => l.classList.remove('ring-4', 'ring-current/70', 'ring-offset-2')); this.classList.add('ring-4', 'ring-current/70', 'ring-offset-2');">
                  <%= f.radio_button :poster_type, style[:value],
                      id: "bulk_poster_type_#{style[:value]}",
                      checked: style[:value] == "color",
                      class: "sr-only" %>
                  <div class="border-4 border-current/20 rounded-lg overflow-hidden transition-all hover:border-current/50">
                    <img src="/posters/<%= style[:preview] %>"
                         alt="<%= style[:title] %>"
                         class="w-full h-auto object-cover" />
                    <div class="p-3 campaign-surface border-t-4 border-current/15">
                      <p class="campaign-font text-sm font-black campaign-text-primary text-center"><%= style[:title] %></p>
                    </div>
                  </div>
                </label>
              <% end %>
            </div>
          </div>

          <!-- Country (for stats) -->
          <div>
            <%= f.label :country_code, "Country", class: "block campaign-font text-sm font-black campaign-text-primary mb-2" %>
            <%= f.select :country_code,
                         country_options_for_select(current_user.country_code),
                         { include_blank: "Select a country..." },
                         { class: "flex h-11 w-full rounded-lg campaign-input px-4 py-2 text-sm" } %>
          </div>

          <!-- Instructions Warning -->
          <div class="campaign-panel-inner p-3 sm:p-4 space-y-2">
            <p class="campaign-font text-xs font-bold campaign-text-primary">Important Rules:</p>
            <ul class="text-xs campaign-text-secondary space-y-1 list-disc list-inside">
              <li>Do not put posters too close to each other</li>
              <li>AI generated and fake posters will result in severe punishment</li>
              <li>Each poster needs its own unique location and proof photo</li>
            </ul>
          </div>

          <!-- Actions -->
          <div class="flex flex-col sm:flex-row gap-3 pt-2">
            <button type="submit"
                    data-bulk-poster-modal-target="submitButton"
                    class="flex-1 campaign-btn campaign-btn--primary justify-center">
              <span data-bulk-poster-modal-target="submitText">
                <%= icon :layers, size: 20 %>
                Generate Bulk Posters
              </span>
              <span data-bulk-poster-modal-target="loadingText" class="hidden">
                <svg class="animate-spin h-5 w-5 inline-block mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Generating...
              </span>
            </button>
            <button type="button"
                    data-action="click->bulk-poster-modal#close"
                    data-bulk-poster-modal-target="cancelButton"
                    class="px-6 py-3 campaign-font font-black text-sm campaign-text-muted hover:campaign-text-primary transition-colors text-center">
              Cancel
            </button>
          </div>
        <% end %>
      <% end %>
    </div>
  </div>
</div>
