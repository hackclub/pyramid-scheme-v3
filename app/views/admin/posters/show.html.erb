<% content_for :title, "Poster Review" %>

<div class="mb-4">
  <%= link_to admin_posters_path(status: params[:status].presence || @poster.verification_status.to_s.presence || 'in_review'), class: "inline-flex items-center gap-2 text-sm text-muted-foreground hover:text-foreground transition-colors" do %>
    <%= icon :chevron_left, size: 16 %>
    Back
  <% end %>
</div>

<div class="flex flex-col gap-3 mb-6">
  <div class="flex items-center gap-3">
    <% if @poster.user&.avatar.present? %>
      <%= image_tag @poster.user.avatar, class: "w-10 h-10 md:w-12 md:h-12 rounded-full flex-shrink-0" %>
    <% else %>
      <div class="w-10 h-10 md:w-12 md:h-12 rounded-full bg-muted flex items-center justify-center flex-shrink-0">
        <%= icon :user, size: 18, class_name: "text-muted-foreground" %>
      </div>
    <% end %>
    <div class="min-w-0 flex-1">
      <h1 class="text-lg md:text-2xl font-bold tracking-tight text-foreground truncate"><%= @poster.user&.display_name || "Deleted User" %></h1>
      <p class="text-xs md:text-sm text-muted-foreground">
        <%= @poster.campaign&.name || "Deleted Campaign" %> Â· <%= time_ago_in_words(@poster.created_at) %> ago
      </p>
    </div>
    <span class="inline-flex items-center rounded-md px-2 md:px-3 py-1 md:py-1.5 text-xs md:text-sm font-medium flex-shrink-0 <%= poster_status_badge_class(@poster.verification_status) %>">
      <%= @poster.verification_status&.humanize || "Unknown" %>
    </span>
  </div>
</div>

<div class="grid gap-6 lg:grid-cols-3 mb-8">
  <div class="lg:col-span-2 space-y-6">
    <div class="rounded-lg border border-border bg-card p-6 shadow-sm">
      <div class="flex items-start justify-between gap-4 mb-4">
        <div>
          <h2 class="text-lg font-semibold text-foreground">Poster details</h2>
          <p class="text-sm text-muted-foreground">Context for this submission.</p>
        </div>
        <% if @poster.verified_by %>
          <span class="text-xs text-muted-foreground">Verified by <%= @poster.verified_by.try(:display_name) || "Admin" %></span>
        <% end %>
      </div>
      <dl class="grid md:grid-cols-2 gap-4">
        <div class="flex flex-col gap-1 rounded-md border border-border/60 bg-secondary/30 p-3">
          <dt class="text-xs uppercase tracking-wide text-muted-foreground">Campaign</dt>
          <dd class="text-sm font-semibold text-foreground"><%= @poster.campaign&.name || "Deleted Campaign" %></dd>
        </div>
        <div class="flex flex-col gap-1 rounded-md border border-border/60 bg-secondary/30 p-3">
          <dt class="text-xs uppercase tracking-wide text-muted-foreground">Referral Code</dt>
          <dd class="text-sm font-semibold text-foreground font-mono"><%= @poster.referral_code || "N/A" %></dd>
        </div>
        <div class="flex flex-col gap-1 rounded-md border border-border/60 bg-secondary/30 p-3">
          <dt class="text-xs uppercase tracking-wide text-muted-foreground">Location</dt>
          <dd class="text-sm text-foreground"><%= @poster.location_description.presence || "Not provided" %></dd>
        </div>
        <div class="flex flex-col gap-1 rounded-md border border-border/60 bg-secondary/30 p-3">
          <dt class="text-xs uppercase tracking-wide text-muted-foreground">Coordinates</dt>
          <dd class="text-sm text-foreground">
            <% if @poster.latitude.present? && @poster.longitude.present? %>
              <%= @poster.latitude %>, <%= @poster.longitude %>
            <% else %>
              Not provided
            <% end %>
          </dd>
        </div>
        <div class="flex flex-col gap-1 rounded-md border border-border/60 bg-secondary/30 p-3">
          <dt class="text-xs uppercase tracking-wide text-muted-foreground">Poster Type</dt>
          <dd class="text-sm text-foreground"><%= @poster.poster_type&.humanize || "N/A" %></dd>
        </div>
        <div class="flex flex-col gap-1 rounded-md border border-border/60 bg-secondary/30 p-3">
          <dt class="text-xs uppercase tracking-wide text-muted-foreground">Poster Group</dt>
          <dd class="text-sm text-foreground">
            <% if @poster.poster_group.present? %>
              <span class="inline-flex items-center gap-1">
                <%= icon :layers, size: 14, class_name: "text-primary" %>
                <span class="font-semibold"><%= @poster.poster_group.name.presence || "Unnamed Group" %></span>
                <span class="text-muted-foreground">(<%= @poster.poster_group.poster_count %> posters)</span>
              </span>
            <% else %>
              <span class="text-muted-foreground">Standalone poster</span>
            <% end %>
          </dd>
        </div>
        <div class="flex flex-col gap-1 rounded-md border border-border/60 bg-secondary/30 p-3">
          <dt class="text-xs uppercase tracking-wide text-muted-foreground">Status reason</dt>
          <dd class="text-sm text-foreground">
            <% if @poster.rejection_reason.present? %>
              <%= @poster.rejection_reason %>
            <% elsif @poster.metadata&.dig("hold_reason").present? %>
              <%= @poster.metadata["hold_reason"] %>
            <% else %>
              None
            <% end %>
          </dd>
        </div>
      </dl>
    </div>

    <div class="rounded-lg border border-border bg-card p-6 shadow-sm space-y-6">
      <h2 class="text-lg font-semibold text-foreground">Proof & Evidence</h2>
      <% if @poster.proof_image.attached? %>
        <div class="overflow-hidden rounded-xl border border-border">
          <%= image_tag @poster.proof_image, class: "w-full max-h-[480px] object-contain bg-black/5" %>
        </div>
      <% else %>
        <div class="rounded-lg border border-dashed border-border bg-secondary/30 p-6 text-center text-sm text-muted-foreground">
          No proof image uploaded.
        </div>
      <% end %>

      <% if @poster.supporting_evidence.attached? %>
        <div>
          <p class="text-sm font-semibold text-foreground mb-3">Supporting evidence</p>
          <div class="flex flex-col gap-2">
            <% @poster.supporting_evidence.each do |file| %>
              <div class="flex items-center justify-between rounded-md border border-border/60 bg-secondary/30 px-3 py-2">
                <div class="flex items-center gap-3">
                  <%= icon :paperclip, size: 16, class_name: "text-muted-foreground" %>
                  <div>
                    <p class="text-sm font-medium text-foreground"><%= file.filename.to_s %></p>
                    <p class="text-xs text-muted-foreground"><%= number_to_human_size(file.byte_size) %></p>
                  </div>
                </div>
                <%= link_to "Open", url_for(file), target: "_blank", class: "text-sm font-semibold text-primary hover:underline" %>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>

    <div class="grid gap-6 md:grid-cols-2">
      <div class="rounded-lg border border-border bg-card shadow-sm">
        <div class="p-6 border-b border-border flex items-center justify-between">
          <div>
            <h3 class="text-lg font-semibold text-foreground">Poster scans</h3>
            <p class="text-sm text-muted-foreground">Recorded inside Rails.</p>
          </div>
          <span class="text-xs font-semibold text-foreground/70"><%= @poster.scan_count %> total</span>
        </div>
        <% if @scan_events.any? %>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="border-b border-border">
                <tr class="text-left">
                  <th class="px-4 py-3 text-xs font-medium text-muted-foreground">Type</th>
                  <th class="px-4 py-3 text-xs font-medium text-muted-foreground">IP / Country</th>
                  <th class="px-4 py-3 text-xs font-medium text-muted-foreground">When</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-border">
                <% @scan_events.each do |scan| %>
                  <tr class="hover:bg-muted/50 transition-colors">
                    <td class="px-4 py-3 text-sm text-foreground"><%= scan.metadata&.[]("referral_type")&.humanize || "Unknown" %></td>
                    <td class="px-4 py-3 text-sm text-muted-foreground">
                      <%= scan.ip_address || "Unknown" %>
                      <% if scan.country_code.present? %>
                        <span class="text-xs font-medium text-foreground ml-1">(<%= scan.country_code %>)</span>
                      <% end %>
                    </td>
                    <td class="px-4 py-3 text-sm text-muted-foreground"><%= time_ago_in_words(scan.created_at) %> ago</td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <div class="p-6">
            <p class="text-sm text-muted-foreground">No scans yet.</p>
          </div>
        <% end %>
      </div>

      <div class="rounded-lg border border-border bg-card shadow-sm">
        <div class="p-6 border-b border-border flex items-center justify-between">
          <div>
            <h3 class="text-lg font-semibold text-foreground">Proxy hits</h3>
            <p class="text-sm text-muted-foreground">Logs from the Python proxy service.</p>
          </div>
          <span class="text-xs font-semibold text-foreground/70"><%= @referral_logs.size %> recent</span>
        </div>
        <% if @referral_logs.any? %>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="border-b border-border">
                <tr class="text-left">
                  <th class="px-4 py-3 text-xs font-medium text-muted-foreground">IP</th>
                  <th class="px-4 py-3 text-xs font-medium text-muted-foreground">User agent</th>
                  <th class="px-4 py-3 text-xs font-medium text-muted-foreground">When</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-border">
                <% @referral_logs.each do |log| %>
                  <tr class="hover:bg-muted/50 transition-colors">
                    <td class="px-4 py-3 text-sm text-foreground font-mono"><%= log.ip_address %></td>
                    <td class="px-4 py-3 text-sm text-muted-foreground"><%= truncate(log.user_agent.to_s, length: 60) %></td>
                    <td class="px-4 py-3 text-sm text-muted-foreground"><%= time_ago_in_words(log.created_at) %> ago</td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <div class="p-6">
            <p class="text-sm text-muted-foreground">No proxy hits recorded yet.</p>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <div class="space-y-6">
    <div class="rounded-lg border border-border bg-card p-6 shadow-sm space-y-4">
      <h3 class="text-lg font-semibold text-foreground">Actions</h3>
      <% if @poster.can_mark_digital? %>
        <!-- Mark as Digital (for pending posters without proof) -->
        <%= button_to mark_digital_admin_poster_path(@poster), method: :post,
            class: "w-full inline-flex items-center justify-center rounded-md px-4 py-2.5 text-sm font-medium bg-purple-600 text-white hover:bg-purple-700 transition-colors",
            data: { turbo_confirm: "Mark this poster as digital? This will mark it as approved for digital sharing. No shards will be awarded." } do %>
          <%= icon :monitor, size: 16, class_name: "mr-2" %> Mark as Digital
        <% end %>
        <p class="text-xs text-muted-foreground">For users sharing digitally (no physical poster). No shards awarded.</p>
        <div class="border-t border-border my-2"></div>
      <% end %>

      <% if !(%w[success digital].include?(@poster.verification_status.to_s)) %>
        <%= button_to verify_admin_poster_path(@poster), method: :post,
            class: "w-full inline-flex items-center justify-center rounded-md px-4 py-2.5 text-sm font-medium bg-green-600 text-white hover:bg-green-700 transition-colors",
            data: { turbo_confirm: "Approve this poster and award shards?" } do %>
          <%= icon :check, size: 16, class_name: "mr-2" %> Verify & award shards
        <% end %>
      <% elsif @poster.verification_status.to_s == "success" %>
        <div class="rounded-md border border-green-500/20 bg-green-500/10 px-3 py-2 text-sm text-green-700">
          Already verified <%= time_ago_in_words(@poster.verified_at || @poster.updated_at) %> ago.
        </div>
      <% elsif @poster.verification_status.to_s == "digital" %>
        <div class="rounded-md border border-purple-500/20 bg-purple-500/10 px-3 py-2 text-sm text-purple-700">
          Marked as digital <%= time_ago_in_words(@poster.verified_at || @poster.updated_at) %> ago.
        </div>
      <% end %>

      <% unless %w[success digital].include?(@poster.verification_status.to_s) %>
        <div class="pt-2 border-t border-border">
          <%= form_with url: hold_admin_poster_path(@poster, status: params[:status]), method: :post, class: "space-y-2" do %>
            <label class="text-xs font-semibold text-muted-foreground block">Hold reason (optional)</label>
            <textarea name="reason" rows="2" class="w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"
                      placeholder="Why is this being paused?"><%= @poster.metadata&.dig("hold_reason") %></textarea>
            <button type="submit" class="w-full inline-flex items-center justify-center rounded-md px-4 py-2.5 text-sm font-medium bg-amber-500 text-white hover:bg-amber-600 transition-colors">
              Put on hold
            </button>
          <% end %>
        </div>
      <% end %>

      <% if !%w[rejected success digital].include?(@poster.verification_status.to_s) %>
        <div class="pt-2 border-t border-border">
          <%= form_with url: reject_admin_poster_path(@poster), method: :post, class: "space-y-2" do %>
            <label class="text-xs font-semibold text-muted-foreground block">Rejection reason</label>
            <textarea name="reason" rows="3" class="w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2" placeholder="Why is this being rejected?" required></textarea>
            <button type="submit" class="w-full inline-flex items-center justify-center rounded-md px-4 py-2.5 text-sm font-medium bg-destructive text-destructive-foreground hover:bg-destructive/90 transition-colors"
                    data-turbo-confirm="Reject this poster? The user will not receive shards.">
              <%= icon :ban, size: 16, class_name: "mr-2" %> Reject poster
            </button>
          <% end %>
        </div>

        <div class="pt-2 border-t border-border">
          <%= form_with url: request_resubmission_admin_poster_path(@poster), method: :post, class: "space-y-2" do %>
            <label class="text-xs font-semibold text-muted-foreground block">Request resubmission</label>
            <textarea name="reason" rows="2" class="w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2" placeholder="What additional evidence is needed?"></textarea>
            <button type="submit" class="w-full inline-flex items-center justify-center rounded-md px-4 py-2.5 text-sm font-medium bg-blue-600 text-white hover:bg-blue-700 transition-colors"
                    data-turbo-confirm="Send this poster back for resubmission? The existing proof will be cleared.">
              <%= icon :refresh_cw, size: 16, class_name: "mr-2" %> Request Resubmission
            </button>
          <% end %>
          <p class="text-xs text-muted-foreground">Clears proof and asks user to resubmit with better evidence.</p>
        </div>
      <% elsif @poster.verification_status.to_s == "rejected" %>
        <div class="rounded-md border border-destructive/20 bg-destructive/10 px-3 py-2 text-sm text-destructive">
          Rejected: <%= @poster.rejection_reason.presence || "Reason not provided" %>
        </div>
      <% end %>
    </div>

    <div class="rounded-lg border border-border bg-card p-6 shadow-sm">
      <h3 class="text-lg font-semibold text-foreground mb-4">Metadata</h3>
      <dl class="space-y-2 text-sm text-muted-foreground">
        <div class="flex justify-between">
          <dt>QR code token</dt>
          <dd class="font-mono text-foreground"><%= @poster.qr_code_token || "N/A" %></dd>
        </div>
        <div class="flex justify-between">
          <dt>Referral code</dt>
          <dd class="font-mono text-foreground"><%= @poster.referral_code || "N/A" %></dd>
        </div>
        <div class="flex justify-between">
          <dt>Expected URL</dt>
          <dd class="font-mono text-foreground text-xs break-all"><%= @poster.referral_url %></dd>
        </div>
        <div class="flex justify-between">
          <dt>Created</dt>
          <dd><%= @poster.created_at.strftime("%b %d, %Y %H:%M") %></dd>
        </div>
        <div class="flex justify-between">
          <dt>Updated</dt>
          <dd><%= @poster.updated_at.strftime("%b %d, %Y %H:%M") %></dd>
        </div>
      </dl>
    </div>

    <% if @poster.proof_image.attached? %>
      <div class="rounded-lg border border-border bg-card p-6 shadow-sm">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-foreground">Auto-verification</h3>
          <% unless %w[success digital].include?(@poster.verification_status.to_s) %>
            <%= button_to retry_auto_verify_admin_poster_path(@poster), method: :post,
                class: "inline-flex items-center gap-1.5 rounded-md px-3 py-1.5 text-xs font-medium bg-blue-600 text-white hover:bg-blue-700 transition-colors",
                data: { turbo_confirm: "Re-run auto-verification on this poster?" } do %>
              <%= icon :refresh_cw, size: 14 %> Retry Auto-Verify
            <% end %>
          <% end %>
        </div>
        <dl class="space-y-3 text-sm">
          <% if @poster.metadata&.dig("auto_verification_attempted_at") %>
            <div>
              <dt class="text-muted-foreground">Attempted at</dt>
              <dd class="text-foreground"><%= Time.parse(@poster.metadata["auto_verification_attempted_at"]).strftime("%b %d, %Y %H:%M") rescue @poster.metadata["auto_verification_attempted_at"] %></dd>
            </div>
          <% else %>
            <div class="rounded-md border border-muted bg-muted/30 px-3 py-2 text-muted-foreground">
              Auto-verification not attempted
            </div>
          <% end %>

          <% if @poster.metadata&.dig("auto_verified") %>
            <div class="rounded-md border border-green-500/20 bg-green-500/10 px-3 py-2 text-green-700">
              Auto-verified successfully
            </div>
          <% elsif @poster.metadata&.dig("auto_verification_error") %>
            <div class="rounded-md border border-red-500/20 bg-red-500/10 px-3 py-2 text-red-700">
              Error: <%= @poster.metadata["auto_verification_error"] %>
            </div>
          <% elsif @poster.metadata&.dig("auto_verification_result") == "qr_not_found" %>
            <div class="rounded-md border border-amber-500/20 bg-amber-500/10 px-3 py-2 text-amber-700">
              QR code not matched - requires manual review
            </div>
          <% end %>

          <% if @poster.metadata&.dig("detected_qr_codes").present? %>
            <div>
              <dt class="text-muted-foreground mb-1">Detected QR codes (<%= @poster.metadata["detected_qr_codes"].size %>)</dt>
              <dd class="space-y-1">
                <% @poster.metadata["detected_qr_codes"].each do |qr| %>
                  <div class="font-mono text-xs text-foreground bg-secondary/50 px-2 py-1 rounded break-all"><%= qr %></div>
                <% end %>
              </dd>
            </div>
          <% elsif @poster.metadata&.dig("auto_verification_attempted_at") %>
            <div class="text-muted-foreground">No QR codes detected in image</div>
          <% end %>
        </dl>
      </div>
    <% end %>
  </div>
</div>
