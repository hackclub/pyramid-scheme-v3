<% content_for :title, "Referral ##{@referral.id}" %>

<div class="mb-6">
  <%= link_to admin_referrals_path, class: "inline-flex items-center gap-2 text-sm text-muted-foreground hover:text-foreground transition-colors" do %>
    <%= icon :arrow_left, size: 16 %>
    Back to Referrals
  <% end %>
</div>

<div class="grid gap-6 lg:grid-cols-3 mb-8">
  <!-- Main Info Card -->
  <div class="lg:col-span-2 rounded-lg border border-border bg-card p-6 shadow-sm">
    <div class="mb-6">
      <div class="flex items-center justify-between mb-4">
        <h1 class="text-2xl font-bold tracking-tight text-foreground">Referral #<%= @referral.id %></h1>
        <span class="inline-flex items-center rounded-md px-3 py-1.5 text-sm font-medium <%= referral_status_badge_class(@referral) %>">
          <%= referral_status_label(@referral) %>
        </span>
      </div>
    </div>

    <div class="space-y-6">
      <!-- Referrer Info -->
      <div class="pb-6 border-b border-border">
        <h3 class="text-sm font-medium text-muted-foreground mb-3">Referrer</h3>
        <div class="flex items-center gap-3">
          <% if @referral.referrer.avatar.present? %>
            <%= image_tag @referral.referrer.avatar, class: "w-12 h-12 rounded-full" %>
          <% end %>
          <div class="flex-1">
            <%= link_to @referral.referrer.display_name, admin_user_path(@referral.referrer), class: "font-medium text-foreground hover:text-primary text-lg" %>
            <div class="text-sm text-muted-foreground"><%= @referral.referrer.email %></div>
            <div class="flex gap-2 mt-1">
              <span class="inline-flex items-center rounded-md px-2 py-1 text-xs font-medium <%= @referral.referrer.admin? ? 'bg-primary/10 text-primary' : 'bg-muted text-muted-foreground' %>">
                <%= @referral.referrer.role.humanize %>
              </span>
              <span class="inline-flex items-center rounded-md px-2 py-1 text-xs font-medium bg-muted text-muted-foreground">
                <%= @referral.referrer.referral_count %> completed referrals
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Referred Info -->
      <div class="pb-6 border-b border-border">
        <h3 class="text-sm font-medium text-muted-foreground mb-3">Referred Person</h3>
        <div class="space-y-2">
          <div>
            <span class="text-sm text-muted-foreground">Identifier:</span>
            <span class="ml-2 font-medium text-foreground"><%= @referral.referred_identifier %></span>
          </div>
          <% if @referral.referred.present? %>
            <div class="rounded-lg border border-border bg-muted/30 p-4 mt-3">
              <div class="flex items-center gap-3">
                <% if @referral.referred.avatar.present? %>
                  <%= image_tag @referral.referred.avatar, class: "w-10 h-10 rounded-full" %>
                <% end %>
                <div class="flex-1">
                  <%= link_to @referral.referred.display_name, admin_user_path(@referral.referred), class: "font-medium text-foreground hover:text-primary" %>
                  <div class="text-sm text-muted-foreground"><%= @referral.referred.email %></div>
                </div>
                <%= link_to "View Profile", admin_user_path(@referral.referred), class: "text-sm font-medium text-primary hover:underline" %>
              </div>
            </div>
          <% else %>
            <div class="rounded-lg border border-border bg-muted/30 p-4 mt-3">
              <div class="text-sm text-muted-foreground">No associated account</div>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Referral Details -->
      <div>
        <h3 class="text-sm font-medium text-muted-foreground mb-3">Referral Details</h3>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <div class="text-sm text-muted-foreground">Campaign</div>
            <div class="font-medium text-foreground mt-1"><%= @referral.campaign.name %></div>
          </div>
          <div>
            <div class="text-sm text-muted-foreground">Type</div>
            <div class="mt-1">
              <span class="inline-flex items-center rounded-md px-2 py-1 text-xs font-medium <%= @referral.referral_type == 'link' ? 'bg-purple-500/10 text-purple-500' : 'bg-orange-500/10 text-orange-500' %>">
                <%= @referral.referral_type.humanize %>
              </span>
            </div>
          </div>
          <div>
            <div class="text-sm text-muted-foreground">Created</div>
            <div class="font-medium text-foreground mt-1"><%= @referral.created_at.strftime("%B %d, %Y at %I:%M %p") %></div>
          </div>
          <% if @referral.verified_at.present? %>
            <div>
              <div class="text-sm text-muted-foreground">Verified</div>
              <div class="font-medium text-foreground mt-1"><%= @referral.verified_at.strftime("%B %d, %Y at %I:%M %p") %></div>
            </div>
          <% end %>
          <% if @referral.completed_at.present? %>
            <div>
              <div class="text-sm text-muted-foreground">Completed</div>
              <div class="font-medium text-foreground mt-1"><%= @referral.completed_at.strftime("%B %d, %Y at %I:%M %p") %></div>
            </div>
          <% end %>
          <% if @referral.external_program.present? %>
            <div>
              <div class="text-sm text-muted-foreground">External Program</div>
              <div class="font-medium text-foreground mt-1"><%= @referral.external_program %></div>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Progress -->
      <div class="pb-6 border-b border-border">
        <h3 class="text-sm font-medium text-muted-foreground mb-3">Coding Progress</h3>
        <div class="space-y-3">
          <div class="flex items-center justify-between text-sm">
            <span class="text-muted-foreground">Required Minutes</span>
            <span class="font-medium text-foreground"><%= @referral.campaign.required_coding_minutes %> min</span>
          </div>
          <div class="flex items-center justify-between text-sm">
            <span class="text-muted-foreground">Tracked Minutes</span>
            <span class="font-medium text-foreground"><%= @referral.tracked_minutes %> min</span>
          </div>
          <div class="w-full bg-muted rounded-full h-3">
            <div class="bg-primary rounded-full h-3 transition-all flex items-center justify-end pr-2" style="width: <%= @referral.progress_percentage %>%">
              <span class="text-[10px] font-bold text-primary-foreground"><%= @referral.progress_percentage %>%</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Metadata -->
      <% if @referral.metadata.present? && @referral.metadata.any? %>
        <div>
          <h3 class="text-sm font-medium text-muted-foreground mb-3">Additional Metadata</h3>
          <div class="rounded-lg border border-border bg-muted/30 p-4">
            <pre class="text-xs text-foreground overflow-x-auto"><%= JSON.pretty_generate(@referral.metadata) %></pre>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Actions Card -->
  <div class="rounded-lg border border-border bg-card p-6 shadow-sm h-fit">
    <h3 class="text-lg font-semibold text-foreground mb-6">Admin Actions</h3>

    <div class="space-y-4">
      <!-- Verify Identity -->
      <% unless @referral.id_verified? || @referral.completed? %>
        <%= button_to "Verify Identity", verify_admin_referral_path(@referral), method: :post,
            class: "w-full inline-flex items-center justify-center rounded-md px-4 py-2 text-sm font-medium bg-yellow-500 text-white hover:bg-yellow-600 transition-colors",
            data: { confirm: "Are you sure you want to verify this referral's identity?" } %>
        <p class="text-xs text-muted-foreground">Mark this referral as identity verified</p>
        <div class="border-t border-border my-4"></div>
      <% end %>

      <!-- Complete Referral -->
      <% if @referral.id_verified? && !@referral.completed? %>
        <%= button_to "Complete Referral", complete_admin_referral_path(@referral), method: :post,
            class: "w-full inline-flex items-center justify-center rounded-md px-4 py-2 text-sm font-medium bg-green-500 text-white hover:bg-green-600 transition-colors",
            data: { confirm: "Are you sure you want to complete this referral? This will award shards to the referrer." } %>
        <p class="text-xs text-muted-foreground">Mark as completed and award shards to referrer</p>
        <div class="border-t border-border my-4"></div>
      <% end %>

      <!-- Update Minutes -->
      <div>
        <h4 class="text-sm font-medium text-foreground mb-3">Update Tracked Minutes</h4>
        <%= form_with url: update_minutes_admin_referral_path(@referral), method: :post, class: "space-y-3" do |f| %>
          <input
            type="number"
            name="referral[tracked_minutes]"
            value="<%= @referral.tracked_minutes %>"
            min="0"
            class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"
          >
          <button
            type="submit"
            class="w-full inline-flex items-center justify-center rounded-md px-4 py-2 text-sm font-medium bg-primary text-primary-foreground hover:bg-primary/90 transition-colors"
          >
            Update Minutes
          </button>
        <% end %>
        <p class="text-xs text-muted-foreground mt-2">Automatically completes if threshold is met</p>
      </div>

      <div class="border-t border-border my-4"></div>

      <!-- Quick Links -->
      <div class="space-y-2">
        <h4 class="text-sm font-medium text-foreground mb-3">Quick Links</h4>
        <%= link_to admin_user_path(@referral.referrer), class: "block w-full text-center rounded-md px-4 py-2 text-sm font-medium border border-border bg-background hover:bg-muted transition-colors" do %>
          View Referrer Profile
        <% end %>
        <% if @referral.referred.present? %>
          <%= link_to admin_user_path(@referral.referred), class: "block w-full text-center rounded-md px-4 py-2 text-sm font-medium border border-border bg-background hover:bg-muted transition-colors" do %>
            View Referred Profile
          <% end %>
        <% end %>
        <%= link_to admin_referrals_path(campaign_id: @referral.campaign_id), class: "block w-full text-center rounded-md px-4 py-2 text-sm font-medium border border-border bg-background hover:bg-muted transition-colors" do %>
          View Campaign Referrals
        <% end %>
      </div>

      <div class="border-t border-border my-4"></div>

      <!-- Delete Referral -->
      <div>
        <%= button_to "Delete Referral", admin_referral_path(@referral), method: :delete,
            class: "w-full inline-flex items-center justify-center rounded-md px-4 py-2 text-sm font-medium bg-red-500 text-white hover:bg-red-600 transition-colors",
            data: { confirm: "Are you sure you want to delete this referral? This action cannot be undone and will NOT refund any awarded shards." } %>
        <p class="text-xs text-muted-foreground mt-2">Permanently delete this referral record</p>
      </div>
    </div>
  </div>
</div>

<!-- Status History -->
<% if @referral.pending? %>
  <div class="rounded-lg border border-border bg-card shadow-sm">
    <div class="p-6 border-b border-border">
      <h3 class="text-lg font-semibold text-foreground">Pending Status Details</h3>
    </div>
    <div class="p-6">
      <div class="grid gap-4 md:grid-cols-2">
        <div>
          <div class="text-sm text-muted-foreground mb-1">Current Status</div>
          <div class="font-medium text-foreground"><%= @referral.pending_status_label %></div>
        </div>
        <% if @referral.metadata.present? && @referral.metadata["verification_status"].present? %>
          <div>
            <div class="text-sm text-muted-foreground mb-1">Verification Status</div>
            <div class="font-medium text-foreground"><%= @referral.metadata["verification_status"].to_s.humanize %></div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
<% end %>
