<% content_for :title, "Video ##{@submission.id}" %>

<div class="space-y-6">
  <div class="flex items-center justify-between">
    <div class="flex items-center gap-4">
      <%= link_to admin_video_submissions_path(status: @submission.status), class: "text-muted-foreground hover:text-foreground" do %>
        <%= icon :arrow_left, size: 20 %>
      <% end %>
      <h1 class="text-2xl font-bold">Video Submission #<%= @submission.id %></h1>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <%# Main content %>
    <div class="lg:col-span-2 space-y-6">
      <%# Video URL %>
      <% if @submission.video_url.present? %>
        <div class="bg-card rounded-lg border border-border p-4">
          <h3 class="font-semibold mb-2">Video URL</h3>
          <%= link_to @submission.video_url, @submission.video_url, target: "_blank", class: "text-primary hover:underline break-all" %>
        </div>
      <% end %>

      <%# Uploaded files %>
      <% if @submission.video_files.attached? %>
        <div class="bg-card rounded-lg border border-border p-4">
          <h3 class="font-semibold mb-3">Uploaded Files (<%= @submission.video_files_attachments.size %>)</h3>
          <div class="grid grid-cols-2 gap-4">
            <% @submission.video_files.each do |file| %>
              <div class="border border-border rounded-lg overflow-hidden">
                <% if file.video? %>
                  <video controls class="w-full h-40 bg-black">
                    <source src="<%= url_for(file) %>" type="<%= file.content_type %>">
                  </video>
                <% elsif file.image? %>
                  <%= link_to url_for(file), target: "_blank" do %>
                    <%= image_tag file, class: "w-full h-40 object-cover" %>
                  <% end %>
                <% else %>
                  <div class="flex items-center justify-center h-40 bg-muted">
                    <%= icon :file, size: 32, class_name: "text-muted-foreground" %>
                  </div>
                <% end %>
                <div class="p-2 bg-muted/50">
                  <p class="text-xs truncate"><%= file.filename %></p>
                  <p class="text-xs text-muted-foreground"><%= number_to_human_size(file.byte_size) %></p>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <%# Reviewer notes %>
      <% if @submission.reviewer_notes.present? %>
        <div class="bg-card rounded-lg border border-border p-4">
          <h3 class="font-semibold mb-2">Reviewer Notes</h3>
          <p class="text-sm text-muted-foreground"><%= @submission.reviewer_notes %></p>
        </div>
      <% end %>
    </div>

    <%# Sidebar %>
    <div class="space-y-6">
      <%# Status %>
      <div class="bg-card rounded-lg border border-border p-4">
        <h3 class="font-semibold mb-3">Status</h3>
        <% status_badge = case @submission.status
          when "pending" then "bg-yellow-100 text-yellow-800"
          when "on_hold" then "bg-orange-100 text-orange-800"
          when "approved" then "bg-green-100 text-green-800"
          when "rejected" then "bg-red-100 text-red-800"
        end %>
        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium <%= status_badge %>">
          <%= @submission.status.humanize %>
        </span>

        <% if @submission.approved? %>
          <div class="mt-3 pt-3 border-t border-border">
            <p class="text-sm text-muted-foreground">Shards Awarded: <span class="font-bold text-foreground"><%= @submission.shards_awarded %></span></p>
          </div>
        <% end %>
      </div>

      <%# Virality %>
      <% if @submission.approved? %>
        <div class="bg-card rounded-lg border border-border p-4">
          <h3 class="font-semibold mb-3">Virality Check</h3>
          <% if @submission.virality_completed? %>
            <% if @submission.is_viral? %>
              <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-purple-100 text-purple-800">
                ðŸ”¥ Viral! +<%= @submission.viral_bonus %> bonus
              </span>
            <% else %>
              <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800">
                Not Viral
              </span>
            <% end %>
          <% else %>
            <% if @submission.metadata["virality_check_requested"] %>
              <p class="text-sm text-muted-foreground mb-3">User requested virality check</p>
            <% end %>
            <%= form_with url: complete_virality_admin_video_submission_path(@submission), method: :post, class: "space-y-3" do |f| %>
              <div>
                <label class="block text-sm font-medium mb-1">Is Viral?</label>
                <select name="is_viral" class="w-full rounded-lg border border-border px-3 py-2 text-sm">
                  <option value="false">No</option>
                  <option value="true">Yes</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Bonus Shards (0-20)</label>
                <input type="number" name="bonus" value="0" min="0" max="20" class="w-full rounded-lg border border-border px-3 py-2 text-sm">
              </div>
              <button type="submit" class="w-full px-4 py-2 bg-purple-600 text-white rounded-lg text-sm font-medium hover:bg-purple-700">
                Complete Virality Check
              </button>
            <% end %>
          <% end %>
        </div>
      <% end %>

      <%# User info %>
      <div class="bg-card rounded-lg border border-border p-4">
        <h3 class="font-semibold mb-3">User</h3>
        <%= link_to @submission.user.display_name, admin_user_path(@submission.user), class: "text-primary hover:underline font-medium" %>
        <p class="text-sm text-muted-foreground"><%= @submission.user.email %></p>
      </div>

      <%# Campaign %>
      <div class="bg-card rounded-lg border border-border p-4">
        <h3 class="font-semibold mb-3">Campaign</h3>
        <p class="font-medium"><%= @submission.campaign.name %></p>
      </div>

      <%# Timestamps %>
      <div class="bg-card rounded-lg border border-border p-4">
        <h3 class="font-semibold mb-3">Timeline</h3>
        <div class="text-sm space-y-2">
          <p>Submitted: <span class="text-muted-foreground"><%= @submission.created_at.strftime("%b %d, %Y %H:%M") %></span></p>
          <% if @submission.reviewed_at %>
            <p>Reviewed: <span class="text-muted-foreground"><%= @submission.reviewed_at.strftime("%b %d, %Y %H:%M") %></span></p>
          <% end %>
        </div>
      </div>

      <%# Actions %>
      <% if @submission.pending? || @submission.on_hold? %>
        <div class="bg-card rounded-lg border border-border p-4 space-y-3">
          <h3 class="font-semibold mb-3">Actions</h3>
          
          <%# Approve %>
          <%= form_with url: approve_admin_video_submission_path(@submission), method: :post, class: "space-y-2" do |f| %>
            <label class="block text-sm font-medium">Shards to award (1-10)</label>
            <input type="number" name="shards" value="5" min="1" max="10" class="w-full rounded-lg border border-border px-3 py-2 text-sm">
            <button type="submit" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700">
              Approve
            </button>
          <% end %>

          <%# Hold %>
          <%= form_with url: hold_admin_video_submission_path(@submission), method: :post, class: "space-y-2 mt-4" do |f| %>
            <input type="text" name="notes" placeholder="Reason (optional)" class="w-full rounded-lg border border-border px-3 py-2 text-sm">
            <button type="submit" class="w-full px-4 py-2 bg-orange-600 text-white rounded-lg text-sm font-medium hover:bg-orange-700">
              Put On Hold
            </button>
          <% end %>

          <%# Reject %>
          <%= form_with url: reject_admin_video_submission_path(@submission), method: :post, class: "space-y-2 mt-4" do |f| %>
            <input type="text" name="notes" placeholder="Reason (optional)" class="w-full rounded-lg border border-border px-3 py-2 text-sm">
            <button type="submit" class="w-full px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-medium hover:bg-red-700">
              Reject
            </button>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</div>
