<% content_for :title, "#{@campaign.name} Assets" %>

<div class="mb-8">
  <%= link_to "â† Back to #{@campaign.name}", admin_campaign_path(@campaign), class: "text-sm text-muted-foreground hover:text-foreground transition-colors" %>
</div>

<div class="flex justify-between items-center mb-8">
  <div>
    <h1 class="text-3xl font-bold tracking-tight text-foreground">Campaign Assets</h1>
    <p class="text-sm text-muted-foreground mt-2">Manage poster templates, previews, logos, and CSS for <%= @campaign.name %>.</p>
  </div>
  <%= link_to "Upload Asset", new_admin_campaign_asset_path(@campaign), class: "inline-flex items-center justify-center rounded-md px-4 py-2 text-sm font-medium bg-primary text-primary-foreground hover:bg-primary/90 transition-colors" %>
</div>

<% if @grouped_assets.any? %>
  <div class="space-y-8">
    <% @grouped_assets.each do |asset_type, assets| %>
      <div class="rounded-lg border border-border bg-card shadow-sm">
        <div class="p-6 border-b border-border">
          <h2 class="text-lg font-semibold"><%= asset_type.humanize.pluralize %></h2>
        </div>
        <div class="p-6">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <% assets.each do |asset| %>
              <div class="rounded-lg border border-border p-4 <%= asset.active? ? '' : 'opacity-50' %>">
                <% if asset.file.attached? %>
                  <% if asset.file.content_type&.start_with?("image/") %>
                    <%= image_tag url_for(asset.file), class: "w-full h-32 object-contain rounded mb-3 bg-muted" %>
                  <% elsif asset.file.content_type == "application/pdf" %>
                    <div class="w-full h-32 flex items-center justify-center rounded mb-3 bg-muted text-muted-foreground">
                      <%= icon :file, size: 48 %>
                    </div>
                  <% else %>
                    <div class="w-full h-32 flex items-center justify-center rounded mb-3 bg-muted text-muted-foreground">
                      <%= icon :file, size: 48 %>
                    </div>
                  <% end %>
                <% end %>

                <div class="space-y-1">
                  <div class="font-medium text-sm"><%= asset.name %></div>
                  <% if asset.variant.present? %>
                    <span class="inline-flex items-center rounded-md px-2 py-0.5 text-xs font-medium bg-muted text-muted-foreground">
                      <%= asset.variant %>
                    </span>
                  <% end %>
                  <% unless asset.active? %>
                    <span class="inline-flex items-center rounded-md px-2 py-0.5 text-xs font-medium bg-red-500/10 text-red-500">
                      Inactive
                    </span>
                  <% end %>
                </div>

                <div class="flex gap-2 mt-3">
                  <% if asset.file.attached? %>
                    <%= link_to "Download", url_for(asset.file), class: "text-xs text-primary hover:underline", target: "_blank" %>
                  <% end %>
                  <%= link_to "Edit", edit_admin_campaign_asset_path(@campaign, asset), class: "text-xs text-primary hover:underline" %>
                  <% if asset.poster_template? %>
                    <%= button_to "Generate Preview", generate_preview_admin_campaign_asset_path(@campaign, asset), method: :post, class: "text-xs text-primary hover:underline", data: { confirm: "Generate a preview image from this PDF template?" } %>
                  <% end %>
                  <%= button_to "Delete", admin_campaign_asset_path(@campaign, asset), method: :delete, class: "text-xs text-red-500 hover:underline", data: { confirm: "Are you sure you want to delete this asset?" } %>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>
<% else %>
  <div class="rounded-lg border border-border bg-card p-12 text-center">
    <div class="text-muted-foreground mb-4">
      <svg class="w-12 h-12 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
      </svg>
    </div>
    <h3 class="text-lg font-medium mb-2">No assets yet</h3>
    <p class="text-sm text-muted-foreground mb-4">Upload poster templates, previews, and other campaign assets.</p>
    <%= link_to "Upload First Asset", new_admin_campaign_asset_path(@campaign), class: "inline-flex items-center justify-center rounded-md px-4 py-2 text-sm font-medium bg-primary text-primary-foreground hover:bg-primary/90 transition-colors" %>
  </div>
<% end %>

<!-- QR Code Coordinates Config -->
<div class="mt-8 rounded-lg border border-border bg-card shadow-sm">
  <div class="p-6 border-b border-border">
    <h2 class="text-lg font-semibold">QR Code Placement</h2>
    <p class="text-sm text-muted-foreground mt-1">Configure where QR codes are placed on poster templates.</p>
  </div>
  <div class="p-6">
    <%= form_with model: [:admin, @campaign], url: admin_campaign_path(@campaign), method: :patch, local: true do |f| %>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <% %w[color bw printer_efficient].each do |variant| %>
          <div class="rounded-lg border border-border p-4">
            <h3 class="font-medium mb-3"><%= variant.humanize %> Poster</h3>
            <% config = @campaign.poster_qr_config_for(variant) %>
            <div class="space-y-3">
              <div>
                <label class="block text-xs text-muted-foreground mb-1">X Position (points)</label>
                <%= number_field_tag "campaign[poster_qr_coordinates][#{variant}][x]", config["x"], class: "w-full rounded-md border border-input bg-background px-2 py-1 text-sm" %>
              </div>
              <div>
                <label class="block text-xs text-muted-foreground mb-1">Y Position (points)</label>
                <%= number_field_tag "campaign[poster_qr_coordinates][#{variant}][y]", config["y"], class: "w-full rounded-md border border-input bg-background px-2 py-1 text-sm" %>
              </div>
              <div>
                <label class="block text-xs text-muted-foreground mb-1">QR Size (points)</label>
                <%= number_field_tag "campaign[poster_qr_coordinates][#{variant}][size]", config["size"], class: "w-full rounded-md border border-input bg-background px-2 py-1 text-sm" %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
      <div class="mt-4">
        <%= f.submit "Save QR Coordinates", class: "inline-flex items-center justify-center rounded-md px-4 py-2 text-sm font-medium bg-primary text-primary-foreground hover:bg-primary/90 transition-colors cursor-pointer" %>
      </div>
    <% end %>
  </div>
</div>
