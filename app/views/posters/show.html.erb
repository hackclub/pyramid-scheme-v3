<% content_for :title, "Poster Â· Flavortown" %>

<div class="mb-6">
  <%= link_to posters_path, class: "inline-flex items-center gap-2 text-sm text-muted-foreground hover:text-foreground transition-colors" do %>
    <%= icon :chevron_left, size: 16 %>
    Back to Posters
  <% end %>
</div>

<!-- Flavortown Header -->
<div class="mb-8 text-center">
  <h1 class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-orange-400 via-red-500 to-pink-500 mb-2">
    ğŸ”¥ FLAVOR<span class="text-yellow-400">TOWN</span> POSTER ğŸ”¥
  </h1>
  <p class="text-muted-foreground">That's money, baby!</p>
</div>

<div class="grid md:grid-cols-2 gap-6 mb-6">
  <!-- QR Code Card -->
  <%= render_card class: "text-center bg-gradient-to-br from-orange-500/10 to-red-500/10 border-2 border-orange-500/30" do %>
    <div class="flex items-center justify-center gap-2 mb-6">
      <%= icon :qr_code, size: 24, class_name: "text-orange-400" %>
      <h3 class="text-xl font-bold text-orange-400">Your Flavortown QR</h3>
    </div>

    <div class="flex justify-center mb-6 bg-white p-4 rounded-lg inline-block">
      <%= image_tag @qr_data_uri, alt: "Poster QR Code", class: "w-64 h-64" %>
    </div>

    <p class="text-xs text-muted-foreground mb-2 break-all font-mono bg-secondary/50 p-2 rounded">
      <%= @poster.referral_url %>
    </p>

    <div class="flex flex-col gap-3 mt-6">
      <%= link_to download_poster_path(@poster), class: "inline-flex items-center justify-center gap-2 px-6 py-3 text-sm font-bold bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-lg hover:from-orange-600 hover:to-red-600 transition-all shadow-lg hover:shadow-xl transform hover:scale-105" do %>
        <%= icon :file_down, size: 18 %>
        Download Poster PDF
      <% end %>

      <button onclick="copyReferralLink()" class="inline-flex items-center justify-center gap-2 px-6 py-3 text-sm font-bold bg-gradient-to-r from-yellow-500 to-orange-500 text-white rounded-lg hover:from-yellow-600 hover:to-orange-600 transition-all shadow-lg hover:shadow-xl transform hover:scale-105">
        <%= icon :copy, size: 18 %>
        <span id="copy-button-text">Copy Referral Link</span>
      </button>
    </div>
  <% end %>

  <!-- Details Card -->
  <%= render_card class: "bg-gradient-to-br from-red-500/10 to-pink-500/10 border-2 border-red-500/30" do %>
    <div class="flex justify-between items-start mb-6">
      <h2 class="text-2xl font-bold text-red-400">ğŸŒ¶ï¸ Poster Details</h2>
      <span class="inline-flex items-center px-3 py-1.5 text-xs font-bold rounded-full <%= 
        case @poster.verification_status
        when 'success' then 'bg-green-500 text-white animate-pulse'
        when 'rejected' then 'bg-red-500 text-white'
        when 'in_review' then 'bg-yellow-500 text-black'
        else 'bg-yellow-500 text-black animate-bounce'
        end %>">
        <%= case @poster.verification_status
          when 'success' then 'âœ“ VERIFIED!'
          when 'rejected' then 'âœ— REJECTED'
          when 'in_review' then 'ğŸ‘€ MANUAL REVIEW'
          else 'â³ PENDING'
        end %>
      </span>
    </div>

    <div class="grid grid-cols-2 gap-4 mb-6">
      <div class="bg-secondary/50 p-3 rounded-lg">
        <p class="text-xs text-muted-foreground mb-1">Campaign</p>
        <p class="font-bold text-foreground"><%= @poster.campaign.name %></p>
      </div>
      <div class="bg-secondary/50 p-3 rounded-lg">
        <p class="text-xs text-muted-foreground mb-1">Created</p>
        <p class="font-bold text-foreground"><%= @poster.created_at.strftime("%b %d, %Y") %></p>
      </div>
      <div class="bg-secondary/50 p-3 rounded-lg">
        <p class="text-xs text-muted-foreground mb-1">Scans</p>
        <p class="font-bold text-2xl text-orange-400"><%= @poster.scan_count %></p>
      </div>
      <div class="bg-secondary/50 p-3 rounded-lg">
        <p class="text-xs text-muted-foreground mb-1">Reward</p>
        <p class="font-bold text-2xl flex items-center justify-center gap-1 text-yellow-400">
          <%= icon :pyramid, size: 20 %>
          <%= @poster.campaign.poster_shards %>
        </p>
      </div>
    </div>

    <% if @poster.location_description.present? %>
      <div class="mb-4 bg-secondary/50 p-3 rounded-lg">
        <p class="text-xs text-muted-foreground mb-1">ğŸ“ Location</p>
        <p class="text-sm font-medium"><%= @poster.location_description %></p>
      </div>
    <% end %>

    <% if @poster.country_code.present? %>
      <div class="mb-4 bg-secondary/50 p-3 rounded-lg">
        <p class="text-xs text-muted-foreground mb-1">ğŸŒ Country</p>
        <p class="text-sm font-medium"><%= country_name_from_code(@poster.country_code) %></p>
      </div>
    <% end %>

    <div class="mb-4 bg-secondary/50 p-3 rounded-lg">
      <p class="text-xs text-muted-foreground mb-1">ğŸ”— Referral Code</p>
      <p class="text-xl font-bold font-mono text-orange-400"><%= @poster.referral_code %></p>
    </div>

    <% if @poster.verification_status == 'rejected' && @poster.rejection_reason.present? %>
      <div class="p-4 bg-red-500/20 border-2 border-red-500 rounded-lg mt-4">
        <p class="text-sm font-bold text-red-400 mb-2">âŒ Rejection Reason</p>
        <p class="text-sm text-foreground"><%= @poster.rejection_reason %></p>
      </div>
    <% end %>

    <% if @poster.verification_status == 'in_review' %>
      <div class="p-4 bg-yellow-500/20 border-2 border-yellow-500 rounded-lg mt-4">
        <p class="text-sm font-bold text-yellow-600 mb-2">ğŸ‘€ Manual Review Required</p>
        <p class="text-sm text-foreground">Your proof is being manually reviewed. This usually happens when the QR code couldn't be automatically detected. Hang tight!</p>
      </div>
    <% end %>

    <% if @poster.resubmission_requested? %>
      <div class="p-4 bg-blue-500/20 border-2 border-blue-500 rounded-lg mt-4">
        <p class="text-sm font-bold text-blue-400 mb-2">ğŸ“¸ Resubmission Requested</p>
        <p class="text-sm text-foreground"><%= @poster.resubmission_reason.presence || "Please submit clearer proof of your poster." %></p>
      </div>
    <% end %>

    <% if @poster.verification_status == 'success' && @poster.verified_at.present? %>
      <div class="p-4 bg-green-500/20 border-2 border-green-500 rounded-lg mt-4">
        <p class="text-sm font-bold text-green-400">
          <%= icon :circle_check, size: 18, class_name: "inline mr-1" %>
          WINNER WINNER CHICKEN DINNER!
        </p>
        <p class="text-xs text-muted-foreground mt-1">
          Verified on <%= @poster.verified_at.strftime("%B %d, %Y at %I:%M %p") %>
        </p>
      </div>
    <% end %>
  <% end %>
</div>

<!-- Upload Proof Section -->
<% if @poster.verification_status == 'pending' || @poster.resubmission_requested? %>
  <%= render_card class: "bg-gradient-to-br from-purple-500/10 to-pink-500/10 border-2 border-purple-500/30" do %>
    <div class="text-center mb-6">
      <h3 class="text-2xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-400 mb-2">
        ğŸ“¸ <%= @poster.resubmission_requested? ? "Resubmit Your Proof!" : "Upload Proof to Get Verified!" %>
      </h3>
      <p class="text-sm text-muted-foreground">
        <%= @poster.resubmission_requested? ? "Take a new photo with clearer evidence and we'll review it!" : "Take a photo of your poster in the wild and we'll auto-verify it!" %>
      </p>
    </div>

    <%= form_with url: upload_proof_poster_path(@poster), method: :post, multipart: true, class: "space-y-4" do |f| %>
      <div class="border-2 border-dashed border-purple-500/50 rounded-lg p-8 text-center bg-secondary/30 hover:bg-secondary/50 transition-colors">
        <label for="proof_image" class="cursor-pointer block">
          <div class="mb-4">
            <%= icon :upload, size: 48, class_name: "mx-auto text-purple-400" %>
          </div>
          <p class="text-sm font-semibold text-foreground mb-2">Click to upload or drag and drop</p>
          <p class="text-xs text-muted-foreground">PNG, JPG, JPEG up to 10MB</p>
          <%= f.file_field :proof_image, accept: "image/*", class: "hidden", id: "proof_image", required: true %>
        </label>
      </div>

      <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4">
        <p class="text-xs font-semibold text-yellow-400 mb-2">ğŸ”¥ PRO TIP:</p>
        <ul class="text-xs text-muted-foreground space-y-1 list-disc list-inside">
          <li>Make sure the QR code is clearly visible</li>
          <li>Good lighting helps with auto-verification</li>
          <li>Include the poster location in the shot</li>
          <li>If auto-verify fails, don't worry - we'll manually review it!</li>
        </ul>
      </div>

      <%= f.submit "Submit for Verification", class: "w-full px-6 py-4 text-base font-bold bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:from-purple-600 hover:to-pink-600 transition-all shadow-lg hover:shadow-xl transform hover:scale-105 cursor-pointer" %>
    <% end %>
  <% end %>
<% end %>

<script>
function copyReferralLink() {
  const url = '<%= @poster.referral_url %>';
  navigator.clipboard.writeText(url).then(() => {
    const button = document.getElementById('copy-button-text');
    const originalText = button.textContent;
    button.textContent = 'âœ“ Copied!';
    setTimeout(() => {
      button.textContent = originalText;
    }, 2000);
  });
}
</script>
