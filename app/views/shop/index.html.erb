<% content_for :title, "#{t('shop.title')} Â· #{t('site.name')}" %>

<div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
  <div>
    <h1 class="text-3xl font-bold tracking-tight text-foreground"><%= t('shop.title') %></h1>
    <p class="text-muted-foreground"><%= t('shop.subtitle') %></p>
  </div>

  <%= form_with url: shop_update_region_path, method: :patch, local: true, data: { controller: "auto-submit" } do |f| %>
    <%= f.select :region,
        @region_options.map { |r| [r[:label], r[:value]] },
        { selected: @user_region },
        class: "text-sm rounded-lg border border-border bg-card px-4 py-2 pr-8 focus:outline-none focus:ring-2 focus:ring-ring appearance-none cursor-pointer",
        data: { action: "change->auto-submit#submit" },
        style: "background-image: url(\"data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e\"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em;" %>
  <% end %>
</div>

<% if @items.any? %>
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    <% @items.each do |item| %>
      <div class="group rounded-2xl bg-transparent p-3">
        <div class="relative">
          <% if item.image_url.present? %>
            <div class="aspect-[4/3] overflow-hidden rounded-xl border border-border/60">
              <%= image_tag item.image_url, class: "w-full h-full object-cover" %>
            </div>
          <% else %>
            <div class="aspect-[4/3] rounded-xl border border-border/60 flex items-center justify-center">
              <%= icon :shopping_bag, size: 40, class_name: "text-muted-foreground" %>
            </div>
          <% end %>

          <% if item.on_sale? %>
            <div class="absolute top-2 right-2 bg-red-500 text-white text-[10px] font-bold px-2 py-1 rounded-md">
              <%= item.savings_percentage %>% OFF
            </div>
          <% end %>
        </div>

        <div class="mt-3">
          <h3 class="text-base font-bold text-foreground mb-1.5"><%= item.name %></h3>
          <p class="text-xs text-muted-foreground mb-3 line-clamp-2"><%= truncate(item.description, length: 80) %></p>

          <div class="flex justify-between items-center">
            <div class="flex items-center gap-1.5 text-sm">
              <%= icon :pyramid, size: 14 %>
              <% if item.on_sale? && item.sale_price_shards.present? %>
                <span class="text-muted-foreground line-through text-xs"><%= number_with_delimiter(item.price_shards) %></span>
                <span class="font-bold"><%= number_with_delimiter(item.current_price) %></span>
              <% else %>
                <span class="font-bold"><%= number_with_delimiter(item.current_price) %></span>
              <% end %>
            </div>

            <% if item.in_stock? %>
              <%= link_to shop_item_path(item), class: "inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium rounded-lg bg-white hover:bg-white/90 text-black border border-border transition-colors" do %>
                Buy
                <%= icon :arrow_right, size: 14 %>
              <% end %>
            <% else %>
              <button type="button" disabled aria-disabled="true" class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium rounded-lg border border-border bg-background text-foreground opacity-60 cursor-not-allowed">
                <%= t('shop.out_of_stock') %>
              </button>
            <% end %>
          </div>

          <% if !item.unlimited_stock? && item.stock_quantity.present? && item.stock_quantity < 10 %>
            <p class="text-[10px] text-yellow-500 mt-2">
              <%= t('shop.low_stock', count: item.stock_quantity) %>
            </p>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
<% else %>
  <%= render_card class: "p-6 border-0 shadow-sm" do %>
    <div class="text-center py-12">
      <%= icon :shopping_bag, size: 48, class_name: "mx-auto text-muted-foreground mb-4" %>
      <p class="text-lg font-medium text-foreground mb-1"><%= t('shop.no_items') %></p>
      <p class="text-muted-foreground"><%= t('shop.no_items_hint') %></p>
    </div>
  <% end %>
<% end %>
