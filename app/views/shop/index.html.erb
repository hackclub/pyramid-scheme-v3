<% content_for :title, "#{t('shop.title')} Â· #{t('site.name')}" %>

<div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
  <div>
    <h1 class="text-3xl font-bold tracking-tight text-foreground"><%= t('shop.title') %></h1>
    <p class="text-muted-foreground"><%= t('shop.subtitle') %></p>
  </div>

  <%= form_with url: shop_update_region_path, method: :patch, local: true, data: { controller: "auto-submit" } do |f| %>
    <div class="flex items-center gap-2">
      <%= icon :globe, size: 14, class_name: "text-muted-foreground" %>
      <%= f.select :region,
          @region_options.map { |r| [r[:label], r[:value]] },
          { selected: @user_region },
          class: "text-sm rounded-lg border border-border bg-card px-4 py-2 pr-8 focus:outline-none focus:ring-2 focus:ring-ring appearance-none cursor-pointer",
          data: { action: "change->auto-submit#submit" },
          style: "background-image: url(\"data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e\"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em;" %>
    </div>
  <% end %>
</div>

<% if @items.any? %>
  <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4">
    <% @items.each do |item| %>
      <%= link_to shop_item_path(item), class: "group block rounded-xl border border-border/40 bg-card/50 hover:bg-card hover:border-border transition-all duration-200 overflow-hidden" do %>
        <div class="relative">
          <% if item.image_url.present? %>
            <div class="aspect-square overflow-hidden bg-neutral-950/5">
              <%= image_tag item.image_url, class: "w-full h-full object-contain p-3 group-hover:scale-105 transition-transform duration-300", loading: "lazy" %>
            </div>
          <% else %>
            <div class="aspect-square flex items-center justify-center bg-neutral-950/5">
              <%= icon :package, size: 32, class_name: "text-muted-foreground/40" %>
            </div>
          <% end %>

          <% if item.on_sale? %>
            <div class="absolute top-2 left-2 bg-red-500/90 text-white text-[10px] font-bold px-2 py-0.5 rounded-md backdrop-blur-sm">
              &minus;<%= item.savings_percentage %>%
            </div>
          <% end %>

          <% if !item.in_stock? %>
            <div class="absolute inset-0 bg-black/40 flex items-center justify-center backdrop-blur-[1px]">
              <span class="text-[11px] font-bold text-white/90 uppercase tracking-wider"><%= t('shop.out_of_stock') %></span>
            </div>
          <% end %>
        </div>

        <div class="px-3 py-3">
          <h3 class="text-sm font-semibold text-foreground leading-tight mb-1 line-clamp-1"><%= item.name %></h3>
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-1 text-sm">
              <%= icon :pyramid, size: 12 %>
              <% if item.on_sale? && item.sale_price_shards.present? %>
                <span class="text-muted-foreground line-through text-[11px]"><%= number_with_delimiter(item.price_shards) %></span>
                <span class="font-bold text-foreground"><%= number_with_delimiter(item.current_price) %></span>
              <% else %>
                <span class="font-bold text-foreground"><%= number_with_delimiter(item.current_price) %></span>
              <% end %>
            </div>
            <% if !item.unlimited_stock? && item.stock_quantity.present? && item.stock_quantity < 10 && item.in_stock? %>
              <span class="text-[10px] text-amber-500 font-medium"><%= item.stock_quantity %> left</span>
            <% end %>
          </div>
        </div>
      <% end %>
    <% end %>
  </div>
<% else %>
  <div class="text-center py-16">
    <%= icon :shopping_bag, size: 40, class_name: "mx-auto text-muted-foreground/40 mb-3" %>
    <p class="text-sm font-medium text-foreground mb-1"><%= t('shop.no_items') %></p>
    <p class="text-xs text-muted-foreground"><%= t('shop.no_items_hint') %></p>
  </div>
<% end %>
