<% content_for :title, "#{@item.name} · #{t('shop.title')} · #{t('site.name')}" %>

<div class="mb-6">
  <%= link_to shop_path, class: "inline-flex items-center gap-1.5 text-sm text-muted-foreground hover:text-foreground transition-colors group" do %>
    <%= icon :arrow_left, size: 14, class_name: "group-hover:-translate-x-0.5 transition-transform" %>
    Shop
  <% end %>
</div>

<div class="max-w-4xl mx-auto">
  <div class="grid md:grid-cols-2 gap-8">
    <div>
      <% if @item.image_url.present? %>
        <div class="aspect-square rounded-xl overflow-hidden border border-border/30 bg-neutral-950/5">
          <%= image_tag @item.image_url, class: "w-full h-full object-contain p-6" %>
        </div>
      <% else %>
        <div class="aspect-square rounded-xl border border-border/30 flex items-center justify-center bg-neutral-950/5">
          <%= icon :package, size: 48, class_name: "text-muted-foreground/40" %>
        </div>
      <% end %>
    </div>

    <div class="space-y-4" data-controller="purchase-confirm">
      <div>
        <% if @item.on_sale? %>
          <div class="inline-flex items-center gap-2 mb-2 bg-red-500 text-white text-xs font-bold px-3 py-1 rounded-full">
            <%= icon :sparkles, size: 14 %>
            SALE <%= @item.savings_percentage %>% OFF
          </div>
        <% end %>
        <h1 class="text-2xl font-bold text-foreground mb-2"><%= @item.name %></h1>
        <p class="text-sm text-muted-foreground leading-relaxed"><%= @item.description %></p>
      </div>

      <div class="flex items-center justify-between gap-4 py-4">
        <div>
          <div class="text-sm text-muted-foreground mb-1">Price</div>
          <div class="flex items-center gap-2">
            <%= icon :pyramid, size: 20 %>
            <% if @item.on_sale? && @item.sale_price_shards.present? %>
              <span class="text-lg text-muted-foreground line-through"><%= number_with_delimiter(@item.price_shards) %></span>
              <span class="text-2xl font-bold text-foreground" data-purchase-confirm-target="unitPrice" data-unit-price="<%= @item.current_price %>"><%= number_with_delimiter(@item.current_price) %></span>
            <% else %>
              <span class="text-2xl font-bold text-foreground" data-purchase-confirm-target="unitPrice" data-unit-price="<%= @item.current_price %>"><%= number_with_delimiter(@item.current_price) %></span>
            <% end %>
          </div>
          <div class="text-xs text-muted-foreground mt-1">
            Total: <span data-purchase-confirm-target="totalPrice"><%= number_with_delimiter(@item.current_price) %></span> shards
          </div>
        </div>

        <div class="text-right">
          <div class="text-sm text-muted-foreground mb-1">Your balance</div>
          <div class="flex items-center justify-end gap-2 text-2xl font-bold text-foreground">
            <%= icon :pyramid, size: 20 %>
            <span><%= number_with_delimiter(current_user.total_shards) %></span>
          </div>
        </div>
      </div>

      <% item_price = @item.current_price %>
      <% max_affordable = item_price > 0 ? (current_user.total_shards / item_price).to_i : 0 %>
      <% select_input_class = "w-full rounded-lg border border-border bg-card px-3 py-2 pr-10 text-sm text-foreground focus:outline-none focus:ring-2 focus:ring-ring appearance-none cursor-pointer transition-all" %>
      <% select_input_style = "background-image: url(\"data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e\"); background-position: right 0.75rem center; background-repeat: no-repeat; background-size: 1.25rem 1.25rem;" %>
      <% if @item.in_stock? && max_affordable > 0 %>
        <%= form_with url: shop_orders_path, method: :post, class: "space-y-3", data: { action: "submit->purchase-confirm#confirmPurchase" } do |f| %>
          <%= f.hidden_field :shop_item_id, value: @item.id %>
          
          <div>
            <label class="block text-sm font-medium text-foreground mb-1.5">Quantity</label>
            <% if @item.physical? %>
              <% max_qty = @item.max_quantity_per_order || 10 %>
              <% max_available = @item.unlimited_stock? ? max_qty : [@item.stock_quantity, max_qty].min %>
              <select name="quantity" id="quantity" required class="<%= select_input_class %>" style="<%= select_input_style %>" data-action="change->purchase-confirm#updateTotal">
                <% (1..[max_available, max_affordable].min).each do |qty| %>
                  <option value="<%= qty %>"><%= qty %></option>
                <% end %>
              </select>
              <p class="text-xs text-muted-foreground mt-1">Maximum 10 per order for physical items</p>
            <% else %>
              <% max_stock = @item.unlimited_stock? ? max_affordable : @item.stock_quantity %>
              <input type="number" 
                     name="quantity" 
                     id="quantity" 
                     value="1" 
                     min="1" 
                     max="<%= [max_stock, max_affordable].min %>"
                     required 
                     class="w-full px-3 py-2 rounded-lg border border-border bg-background text-foreground text-sm focus:outline-none focus:ring-1 focus:ring-foreground/20 transition-all" 
                     data-action="change->purchase-confirm#updateTotal input->purchase-confirm#updateTotal">
              <p class="text-xs text-muted-foreground mt-1">You can afford up to <%= number_with_delimiter(max_affordable) %> at <%= number_with_delimiter(item_price) %> shards each</p>
            <% end %>
          </div>
          
          <div data-controller="address-selector">
            <label class="block text-xs font-medium text-foreground mb-1.5">Shipping Address</label>
            <div id="address-selector" class="space-y-2">
              <select name="shop_order[shipping_address]" id="address_select" data-address-selector-target="select" required class="<%= select_input_class %>" style="<%= select_input_style %>">
                <option value="">Loading addresses...</option>
              </select>
            </div>
            <a href="https://auth.hackclub.com/addresses" target="_blank" class="text-xs text-muted-foreground hover:text-foreground mt-1.5 inline-flex items-center gap-1 transition-colors">
              <span>Manage Addresses</span>
              <%= icon :external_link, size: 10 %>
            </a>
          </div>

          <%= f.submit "Buy →", class: "w-full inline-flex items-center justify-center gap-2 px-5 py-2.5 text-sm font-semibold rounded-lg bg-white hover:bg-white/90 text-black border border-border transition-all", data: { disable_with: "Processing..." } %>
        <% end %>
      <% elsif !@item.in_stock? %>
        <div class="p-3 rounded-lg border border-border/40 bg-background">
          <p class="text-sm font-semibold text-foreground">Out of Stock</p>
          <p class="text-xs text-muted-foreground mt-0.5">This item is currently unavailable.</p>
        </div>
      <% else %>
        <div class="p-3 rounded-lg border border-border/40 bg-background">
          <p class="text-sm font-semibold text-foreground">Insufficient Shards</p>
          <p class="text-xs text-muted-foreground mt-0.5">You need <%= number_with_delimiter(@item.current_price - current_user.total_shards) %> more shards to purchase this item.</p>
        </div>
      <% end %>

      <div class="flex items-center gap-3 pt-3 border-t border-border/40 text-xs text-muted-foreground">
        <% unless @item.unlimited_stock? %>
          <% stock = @item.stock_quantity || 0 %>
          <% if stock == 0 %>
            <span class="inline-flex items-center gap-1">
              <%= icon :x_circle, size: 12, class_name: "text-red-400" %>
              Out of stock
            </span>
          <% elsif stock < 10 %>
            <span class="inline-flex items-center gap-1 text-amber-500">
              <%= icon :alert_triangle, size: 12 %>
              Only <%= stock %> left
            </span>
          <% else %>
            <span class="inline-flex items-center gap-1">
              <%= icon :check_circle, size: 12, class_name: "text-emerald-500" %>
              In stock
            </span>
          <% end %>
        <% else %>
          <span class="inline-flex items-center gap-1">
            <%= icon :check_circle, size: 12, class_name: "text-emerald-500" %>
            In stock
          </span>
        <% end %>
        <% if @item.max_per_user %>
          <span class="text-border">·</span>
          <span>Limit <%= @item.max_per_user %> per person</span>
        <% end %>
      </div>
    </div>
  </div>
</div>
