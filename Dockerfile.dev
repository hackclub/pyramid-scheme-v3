# syntax=docker/dockerfile:1
# check=error=true

# Development Dockerfile for docker-compose.
# - Installs development gems
# - Installs Node dependencies (Tailwind plugins)
# - Intended to be used with a bind mount of the app source

ARG RUBY_VERSION=3.4.7
FROM docker.io/library/ruby:${RUBY_VERSION}-slim

WORKDIR /rails

# System deps (keep roughly in sync with production Dockerfile)
RUN apt-get update -qq && \
    apt-get install --no-install-recommends -y \
      curl \
      git \
      build-essential \
      libpq-dev \
      libyaml-dev \
      pkg-config \
      nodejs \
      npm \
      libvips \
      postgresql-client \
      python3 python3-venv python3-pip \
      libzbar0 libgl1 libglib2.0-0 && \
    rm -rf /var/lib/apt/lists /var/cache/apt/archives

ENV RAILS_ENV="development" \
    BUNDLE_PATH="/usr/local/bundle"

# Install Ruby gems
COPY Gemfile Gemfile.lock ./
COPY vendor ./vendor
RUN bundle install

# Install Node deps (Tailwind plugins)
COPY package.json ./
COPY package-lock.json* ./
RUN if [ -f package-lock.json ]; then npm ci; else npm install; fi

# Copy the rest of the app (will be overridden by bind mount in docker-compose)
COPY . .

ENTRYPOINT ["/rails/bin/docker-entrypoint"]

EXPOSE 4444
ENV PORT=4444

CMD ["bin/dev"]
